/*
La función `TreatAsContent()` en AMPScript se usa para convertir una cadena de texto en contenido que se pueda interpretar correctamente dentro del contexto del email o la solicitud HTTP, especialmente cuando se trata de contenido que involucra variables y valores dinámicos.

¿Qué hace `TreatAsContent()`?
Cuando usas `TreatAsContent()` en AMPScript, esta función evalúa el contenido de una cadena para permitir la correcta interpretación de valores dinámicos dentro de la misma. Es particularmente útil cuando quieres que los datos o expresiones dentro de una cadena sean interpretados correctamente como parte de un bloque de código dinámico.

En el caso de un JSON, por ejemplo, los valores dentro de la cadena (como `@FirstName`, `@LastName`, etc.) se concatenan con otros textos y el uso de `TreatAsContent()` garantiza que los valores de esas variables sean interpretados como parte de la estructura y no simplemente como texto.

Ejemplo de uso de `TreatAsContent()`:

Imagina que tienes una estructura JSON como esta:

SET @Payload = Concat('{
    "ContactKey": "', @Email, '",
    "FirstName": "', @FirstName, '",
    "LastName": "', @LastName, '"
}')

Sin embargo, sin `TreatAsContent()`, AMPScript puede tratar el resultado de esta cadena como un simple texto, no como un valor de contenido dinámico. Usar `TreatAsContent()` asegura que las variables como `@FirstName` y `@LastName` se resuelvan correctamente:

SET @Payload = TreatAsContent(Concat('{
    "ContactKey": "', @Email, '",
    "FirstName": "', @FirstName, '",
    "LastName": "', @LastName, '"
}'))

Con esto, `@FirstName` y `@LastName` se interpretan como valores dinámicos dentro del JSON y no como texto estático.

Resumen
- `TreatAsContent()` asegura que el contenido dentro de una cadena sea procesado correctamente, especialmente cuando se incluyen variables.
- Es útil cuando concatenas valores dinámicos dentro de una cadena compleja como un JSON o HTML.

Este comportamiento es particularmente relevante cuando usas funciones como `HTTPPost2()` que requieren un JSON correctamente formado para la solicitud.
*/

%%[
SET @SubKey = GUID()
SET @FirstName = Trim(RequestParameter('firstName'))
SET @LastName = Trim(RequestParameter('lastName'))
SET @EmailAddress = Trim(RequestParameter('email'))
SET @Birthday = Trim(RequestParameter('birthday'))
SET @GameReward = Trim(RequestParameter('gameReward'))
SET @SolarProduct = Trim(RequestParameter('solarProduct'))
SET @PreContract = Trim(RequestParameter('preContract'))
SET @isPolicy = Trim(RequestParameter('isPolicy'))
SET @SystemDate  = Now(1)
SET @CreatedDate = FormatDate(SystemDateToLocalDate(@SystemDate), "DD MMMM YYYY HH:mm", "en-US")
SET @TipoCliente = "PPSS"
SET @AuthPayload = TreatAsContent(Concat('
  {
    "grant_type": "client_credentials",
    "account_id": "510011124",
    "client_id": "trbcn36l0xvhaav9dkjbvt9w",
    "client_secret": "vMYA6wjVqU0iKUmSujR1QuUT",
    "scope": "tracking_events_write event_notification_subscription_delete event_notification_subscription_update event_notification_subscription_read event_notification_subscription_create event_notification_callback_delete event_notification_callback_update event_notification_callback_read event_notification_callback_create marketing_cloud_connect_send marketing_cloud_connect_write marketing_cloud_connect_read ott_channels_write ott_channels_read ott_chat_messaging_send ott_chat_messaging_read workflows_read tags_read approvals_read tags_write approvals_write workflows_write webhooks_write webhooks_read users_write users_read accounts_write accounts_read campaign_write campaign_read calendar_write calendar_read tracking_events_read file_locations_write file_locations_read data_extensions_write data_extensions_read list_and_subscribers_write list_and_subscribers_read web_write web_publish social_write social_read social_publish social_post sms_write sms_send sms_read push_write push_send push_read email_write email_send email_read journeys_write journeys_read journeys_execute automations_write automations_read automations_execute saved_content_write saved_content_read documents_and_images_write documents_and_images_read offline"
  }
'))
HTTPPost('https://mcm3-rvv-d4cz50jm6nszgy0rzn4.auth.marketingcloudapis.com/v2/token', 'application/json', '{
    "grant_type": "client_credentials",
    "account_id": "510011124",
    "client_id":"trbcn36l0xvhaav9dkjbvt9w",
    "client_secret":"vMYA6wjVqU0iKUmSujR1QuUT",
    "scope": "tracking_events_write event_notification_subscription_delete event_notification_subscription_update event_notification_subscription_read event_notification_subscription_create event_notification_callback_delete event_notification_callback_update event_notification_callback_read event_notification_callback_create marketing_cloud_connect_send marketing_cloud_connect_write marketing_cloud_connect_read ott_channels_write ott_channels_read ott_chat_messaging_send ott_chat_messaging_read workflows_read tags_read approvals_read tags_write approvals_write workflows_write webhooks_write webhooks_read users_write users_read accounts_write accounts_read campaign_write campaign_read calendar_write calendar_read tracking_events_read file_locations_write file_locations_read data_extensions_write data_extensions_read list_and_subscribers_write list_and_subscribers_read web_write web_publish social_write social_read social_publish social_post sms_write sms_send sms_read push_write push_send push_read email_write email_send email_read journeys_write journeys_read journeys_execute automations_write automations_read automations_execute saved_content_write saved_content_read documents_and_images_write documents_and_images_read offline"
}', @Response)
/*
  HttpPost2(urlEndpoint,
       contentTypeHeader,
       contentToPost,
       boolExceptionOnError,
       response,
       responseRowSet,
       headerName1, headerValue1,
       [headerName2, headerValue2...] )
  
  HTTPPostWithRetry(urlEndpoint,
                  contentTypeHeader,
                  content,
                  numRetries,
                  boolReschedule,
                  boolReturnExceptionOnError,
                  responseStatus,
                  responseContentRowset,
                  headerName1, headerValue1,
                  [headerName2, headerValue2...] )

  "EventDefinitionKey": "APIEvent-cdccc77a-22aa-882c-e9c5-27d4cd65d03f",
  "Data": {
      "SubscriberKey": "TESTING",
      "EmailAddress": "EMAIL@EMAIL.COM",
      "FirstName": "A",
      "LastName": "B",
      "Birthday": "23 October 1970 00:00",
      "GameReward": "20%",
      "SolarProduct": " Solar Plus",
      "PreContract": "CT600004",
      "isPolicy": "true",
      "CreatedDate": "15 January 2025 13:09"
  }
*/
IF @HttpStatus == 200 THEN
    SET @AccessBearerToken = Field(@Response, "access_token")
    SET @EvtDefKey = "APIEvent-cdccc77a-22aa-882c-e9c5-27d4cd65d03f"
    SET @Payload = TreatAsContent(Concat(
        '{"ContactKey": "', @SubKey, '", ',
        '"EventDefinitionKey": "', @EvtDefKey, '", ',
        '"Data": { ',
        '"SubscriberKey": "', @SubKey, '", ',
        '"EmailAddress": "', @EmailAddress, '", ',
        '"FirstName": "', @FirstName, '", ',
        '"LastName": "', @LastName, '", ',
        '"Birthday": "', @Birthday, '", ',
        '"GameReward": "', @GameReward, '", ',
        '"SolarProduct": "', @SolarProduct, '", ',
        '"PreContract": "', @PreContract, '", ',
        '"isPolicy": "', @isPolicy, '", ',
        '"CreatedDate": "', @CreatedDate, '"}}'
    ))
    HTTPPost2('https://mcm3-rvv-d4cz50jm6nszgy0rzn4.rest.marketingcloudapis.com/interaction/v1/events', 'application/json', @Payload, true, @Response, @ResponseRows, 'Authorization', @AccessBearerToken)
    IF @HttpStatus == 201 THEN
        Output("<p>¡Gracias! Tu información ha sido procesada exitosamente.</p>")
    ELSE
        Output("<h2 align='center' style='color: red;'>404 Not Found</h2>")
    ENDIF
ELSE
    Output("<h2 align='center' style='color: red;'>401 Error</h2>")
ENDIF

Output(V(@Response))
]%%
