<div style="display: none">
%%[
VAR @SubKey, @FirstName, @LastName, @EmailAddress, @ReqBirthday, @Birthday, @GameReward, @SolarProduct, @PreContract, @isPolicy, @SystemDate, @LocalDate, @DateString

SET @SubKey = GUID()
SET @EmailAddress = RequestParameter('email')
SET @FirstName = RequestParameter('firstName')
SET @LastName = RequestParameter('lastName')

SET @ReqBirthday = RequestParameter('birthday')
SET @FormattedBirthday = FormatDate(@ReqBirthday, "dd/MM/yyyy")

SET @GameReward = RequestParameter('gameReward')
SET @SolarProduct = RequestParameter('solarProduct')
SET @PreContract = RequestParameter('preContract')
SET @isPolicy = RequestParameter('isPolicy')

SET @SystemDate = Now()
SET @LocalDate = SystemDateToLocalDate(@SystemDate)
SET @DateString = FormatDate(@LocalDate, "dd/MM/yyyy", "hh:mm:ss")

/* InsertDE('DE_Captacion_Solar', 'SubscriberKey', @SubKey, 'EmailAddress', @EmailAddress, 'FirstName', @FirstName, 'LastName', @LastName, 'Birthday', @FormattedBirthday, 'GameReward', @GameReward, 'SolarProduct', @SolarProduct, 'PreContract', @PreContract, 'isPolicy', @isPolicy, 'CreatedDate', @DateString) */
]%%
</div>
<script runat="server">
  Platform.Load('Core', '1.1.1');

  var data = {
    SubscriberKey: Variable.GetValue('@SubKey'),
    FirstName: Variable.GetValue('@FirstName'),
    LastName: Variable.GetValue('@LastName'),
    Birthday: Variable.GetValue('@FormattedBirthday'),
    GameReward: Variable.GetValue('@GameReward'),
    SolarProduct: Variable.GetValue('@SolarProduct'),
    PreContract: Variable.GetValue('@PreContract'),
    isPolicy: Variable.GetValue('@isPolicy'),
    CreatedDate: Variable.GetValue('@DateString'),
  };

  var setup = {
    authBaseURI: 'https://mcm3-rvv-d4cz50jm6nszgy0rzn4.auth.marketingcloudapis.com',
    restBaseURI: 'https://mcm3-rvv-d4cz50jm6nszgy0rzn4.rest.marketingcloudapis.com',
    clientId: 'trbcn36l0xvhaav9dkjbvt9w',
    clientSecret: 'vMYA6wjVqU0iKUmSujR1QuUT',
    accountId: '510011124',
    eventDefinitionKey: 'APIEvent-cdccc77a-22aa-882c-e9c5-27d4cd65d03f',
  };

  function getToken(setup) {
    var config = {
      url: setup.authBaseURI + '/v1/token',
      contentType: 'application/json',
      payload: {
        client_id: setup.clientId,
        client_secret: setup.clientSecret,
        account_id: setup.accountId,
        grant_type: 'client_credentials',
      },
    };

    var content = [0];
    var statusCode = Platform.Function.HTTPPost(config.url, config.contentType, Stringify(config.payload), null, null, content);

    if (statusCode == 200) {
      var res = Platform.Function.ParseJSON(content[0]);
      return res.access_token;
      console.log(res.access_token)
    } else {
      return false;
    }
  }

  function triggerEvent(token, setup, data) {
    var config = {
      url: setup.restBaseURI + 'interaction/v1/events',
      contentType: 'application/json',
      headerName: ['Authorization'],
      headerValue: ['Bearer ' + token],
      payload: {
        ContactKey: data.SubscriberKey,
        EventDefinitionKey: setup.eventDefinitionKey,
        Data: data,
      },
    };

    var req = HTTP.Post(
      config.url,
      config.contentType,
      Stringify(config.payload),
      config.headerName,
      config.headerValue,
    );

    if (req.StatusCode == 201) {
      var res = Platform.Function.ParseJSON(req['Response'][0]);
      if (res.eventInstanceId != null && res.eventInstanceId != '') return true;
    } else {
      return false;
    }
  }

  try {
    var token = getToken(setup);
    var success = false;
    if (!!token) success = triggerEvent(token, setup, data);
    if (!!success) Write('Subscriber was successfully injected into the Journey');
    else Write('Failed to inject subscriber into the Journey');
  } catch (err) {
    Write(Stringify(err));
  }
</script>

// ********************************************************************
